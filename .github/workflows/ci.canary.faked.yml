name: CI Canary
env:
  GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}

on:
  push:
    branches: ["upload-documentation-of-sdks"]

jobs:
  publish:
    name: FAKED = Publish canary packages to registries
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Use Node.js 16.x
        uses: actions/setup-node@v1
        with:
          node-version: 16.x

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build
        run: yarn build

      - name: Setup canary package versions locally
        run: |
          shortRev=$(git rev-parse --short ${{ github.sha }})
          preId=dev.${shortRev}
          yarn lerna version prerelease --yes --no-git-tag-version --preid ${preId}

      - name: Build HTML documentation of SDK-s
        run: |
          yarn --cwd packages/sdk-core doc:html
          yarn --cwd packages/sdk-redux doc:html
      
      - name: Get versions for sdk-core & sdk-redux
        id: sdk-versions
        run: |
          SDK_CORE_VERSION=`jq -r .version packages/sdk-core/package.json`
          echo "::set-output name=SDK_CORE_VERSION::$SDK_CORE_VERSION"

          SDK_REDUX_VERSION=`jq -r .version packages/sdk-redux/package.json`
          echo "::set-output name=SDK_REDUX_VERSION::$SDK_REDUX_VERSION"
      
      - name: Upload sdk-core HTML documentation
        uses: ./build-scripts/s3cloudfront-hosting/actions/sync
        with:
          local_build_dir: packages/sdk-core/dist/docs
          aws_region: eu-west-2
          aws_access_key_id: ${{ secrets.SITE_DEPLOYER_AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.SITE_DEPLOYER_AWS_SECRET_ACCESS_KEY }}
          s3_uri: ${{ format("{0}refs/sdk-core@{1}", secrets.SITE_DEPLOYER_AWS_S3_DOCS_URI, steps.sdk-versions.outputs.SDK_CORE_VERSION) }}
          cloudfront_distribution_id: E2GBJEOIC4HGWU

      - name: Upload sdk-redux HTML documentation
        uses: ./build-scripts/s3cloudfront-hosting/actions/sync
        with:
          local_build_dir: packages/sdk-redux/dist/docs
          aws_region: eu-west-2
          aws_access_key_id: ${{ secrets.SITE_DEPLOYER_AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.SITE_DEPLOYER_AWS_SECRET_ACCESS_KEY }}
          s3_uri: ${{ format("{0}refs/sdk-redux@{1}", secrets.SITE_DEPLOYER_AWS_S3_DOCS_URI, steps.sdk-redux-version.outputs.SDK_REDUX_VERSION) }}
          cloudfront_distribution_id: E2GBJEOIC4HGWU